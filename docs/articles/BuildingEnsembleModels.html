<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building Ensemble Models • EnsemblePatientLevelPrediction</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Building Ensemble Models">
<meta property="og:description" content="EnsemblePatientLevelPrediction">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EnsemblePatientLevelPrediction</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BuildingEnsembleModels.html">Building Ensemble Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://ohdsi.github.io/PatientLevelPrediction">PatientLevelPrediction</a>
</li>
<li>
  <a href="https://ohdsi.github.io/PatientLevelPrediction/articles/BestPractices.html">Best Practices</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/EnsemblePatientLevelPrediction">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="BuildingEnsembleModels_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Building Ensemble Models</h1>
                        <h4 class="author">Jenna Reps, Xiaoyong Pan, Peter R. Rijnbeek</h4>
            
            <h4 class="date">2022-03-24</h4>
      
      
      <div class="hidden name"><code>BuildingEnsembleModels.Rmd</code></div>

    </div>

    
    
<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{Building Ensemble Models}
-->
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Ensemble models combine several models to improve the overall performance. Traditionally, weak learners were combined to boost performance but recent results show that combining several strong approaches can also result in a better performance. There are many examples in literature where ensemble models outperform individual models using stacking, i.e. a final logistic regression layer across the individual model outputs, but other approaches like weighting has also shown promising results.</p>
<p>An ensemble model consists of a set of base models that make predictions and a mapping from the base model predictions to a single prediction (the ensemble strategy), see a visualization of this below.</p>
<div class="figure">
<img src="images/ensemblePredictions.png" alt=""><p class="caption">Making predictions with an ensemble model</p>
</div>
<p>This vignette describes how you can use the Observational Health Data Science and Informatics (OHDSI) <a href="http://github.com/OHDSI/EnsemblePatientLevelPrediction"><code>EnsemblePatientLevelPrediction</code></a> package to build ensemble models. This vignette assumes you have read and are comfortable with building single patient level prediction models as described in the <a href="https://github.com/OHDSI/PatientLevelPrediction/blob/master/inst/doc/BuildingPredictiveModels.pdf"><code>BuildingPredictiveModels</code> vignette</a>.</p>
<p>This will enable studying ensemble methods at scale in the OHDSI data network.</p>
<p>In the EnsemblePatientLevelPrediction package, various ensemble strategies for combining base models have been implemented:</p>
<ol style="list-style-type: decimal">
<li>Uniform weighted ensemble: Calculate the average probability from individual models</li>
<li>Metric weighted ensemble: Calculate the weighted average probability from individual models using a metric such as cross validation AUROC as weights.</li>
<li>Stacked ensemble: Train a logistics regression on outputs from individual models</li>
</ol>
<p>In addition, it is possible to create custom ensemble combinators.</p>
</div>
<div id="software-dependencies" class="section level1">
<h1 class="hasAnchor">
<a href="#software-dependencies" class="anchor"></a>Software Dependencies</h1>
<p>To run EnsemblePatientLevelPrediction users will need to have a working version of the R package PatientLevelPrediction.</p>
<p>Certain models in PatientLevelPrediction depend on Python or Java. If using Python/Java backend base models (e.g., KNN, adaBoost, randomForest, SVM, decisionTree) in your ensemble, please see instructions for configuring these in <a href="https://ohdsi.github.io/PatientLevelPrediction/articles/PatientLevelPrediction.html">this article</a></p>
</div>
<div id="other-requirements" class="section level1">
<h1 class="hasAnchor">
<a href="#other-requirements" class="anchor"></a>Other Requirements</h1>
<p>To develop ensemble models using EnsemblePatientLevelPrediction you need either:</p>
<ul>
<li>An OMOP CDM database with known connection settings that can be used to download data for the development of new models</li>
<li>Multiple models developed using the PatientLevelPrediction (either loaded in R or saved in a directory). These must be runPlp objects that contain the model, the internal predictions and the internal validation performance.</li>
</ul>
</div>
<div id="usage" class="section level1">
<h1 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h1>
<p>To develop an ensemble you need to provide:</p>
<ol style="list-style-type: decimal">
<li>The model designs or previously developed models - these are combined to create the ensemble</li>
<li>The filtering settings - these are rules used to determine whether a model should be included in the ensemble based on internal validation performance</li>
<li>The combination settings - these specify how to learn the process to combine the included models (e.g., via a uniform fusion, normalized AUROC or stacking)</li>
</ol>
<p>A visualization of how an ensemble is developed can be seen below:</p>
<div class="figure">
<img src="images/ensembleDevelopment.png" alt=""><p class="caption">Ensemble model</p>
</div>
<div id="example-1-developing-a-fusion-ensemble-using-a-list-of-model-designs" class="section level2">
<h2 class="hasAnchor">
<a href="#example-1-developing-a-fusion-ensemble-using-a-list-of-model-designs" class="anchor"></a>Example 1: Developing a Fusion ensemble using a list of model designs</h2>
<p>In this example we will show you how to develop an ensemble from scratch using an OMOP CDM database connection and model designs (created using the <a href="http://github.com/OHDSI/PatientLevelPrediction"><code>PatientLevelPrediction</code></a> createModelDesign() function).</p>
<div id="database-connection" class="section level3">
<h3 class="hasAnchor">
<a href="#database-connection" class="anchor"></a>Database connection</h3>
<p>We will use the <code>Eunomia</code> R package that contains an sql lite database with data in the OMOP CDM format for demonstration.</p>
<p>The following code initiates the Eunomia OMOP CDM database, configures the connectionDetails and then uses the <code>createDatabaseDetails()</code> in PatientLevelPrediction to specify where the data required when developing a prediction are found:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/createCohorts.html">createCohorts</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span>

<span class="va">databaseDetails</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createDatabaseDetails.html">createDatabaseDetails</a></span><span class="op">(</span>
  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>, 
  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,
  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>, 
  cohortTable <span class="op">=</span> <span class="st">"cohort"</span>, 
  cohortId <span class="op">=</span> <span class="fl">4</span>, 
  outcomeIds <span class="op">=</span> <span class="fl">3</span>,
  outcomeDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>, 
  outcomeTable <span class="op">=</span>  <span class="st">"cohort"</span>, 
  cdmDatabaseName <span class="op">=</span> <span class="st">'eunomia'</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="base-model-design" class="section level3">
<h3 class="hasAnchor">
<a href="#base-model-design" class="anchor"></a>Base Model Design</h3>
<p>The next step is designing the models that we wish to potentially combine via an ensemble. To do this, we use the <code>createModelDesign()</code> function in PatientLevelPrediction. This requires:</p>
<ol style="list-style-type: decimal">
<li>Specifying the cohortId for the target population</li>
<li>Specifying the outcomeId for the outcome</li>
<li>A specification of the candidate covariates (created using <code><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html">FeatureExtraction::createCovariateSettings()</a></code>) that will be used by the model.</li>
<li>Any inclusion criteria implemented at data extraction specified via the <code><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html">PatientLevelPrediction::createRestrictPlpDataSettings()</a></code> such as minimum observation time in the database (washoutPeriod) or whether the include patients multiple times in the data or restrict to the first cohort entry (firstExposureOnly).</li>
<li>Any inclusion criteria implemented after data extraction that can be specified via the <code><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html">PatientLevelPrediction::createStudyPopulationSettings()</a></code> and specifications for the time-at-risk period to determine the outcome labels.</li>
<li>The model settings the specify which classifier/survival model to train and the hyper-parameter search.</li>
<li>The preprocessing settings specified by <code><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createPreprocessSettings.html">PatientLevelPrediction::createPreprocessSettings()</a></code> where you can pick whether to normalize the data or remove rare/redundant covariates.</li>
</ol>
<p>You can also optionally specify feature engineering settings and data sampling settings (e.g., over/under sampling).</p>
</div>
<div id="model-design-1" class="section level3">
<h3 class="hasAnchor">
<a href="#model-design-1" class="anchor"></a>Model Design 1</h3>
<p>For the first model we predict the outcome occurring within 2 years of the index date using a LASSO logistic regression model with demographic covariates plus conditions/drugs that occur in the year prior to index (but not included index):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># example model design 1</span>

<span class="co"># 1. specify the cohort_definition_id for the target cohort</span>
<span class="va">targetId</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># 2. specify the cohort_definition_id for the outcome</span>
<span class="va">outcomeId</span> <span class="op">&lt;-</span> <span class="fl">3</span> 

<span class="co"># 3. specify the covariates</span>
<span class="co"># we include gender, age, race, ethnicity, age in 5 year groups,</span>
<span class="co"># conditions groups (using the vocabulary hierarchy) in the past</span>
<span class="co"># 365 days and drug ingredients in the past 365 days</span>
<span class="co"># we do not include conditions/drugs that occur at index</span>
<span class="va">covSet</span> <span class="op">&lt;-</span> <span class="fu">FeatureExtraction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html">createCovariateSettings</a></span><span class="op">(</span>
  useDemographicsGender <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAge <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsRace <span class="op">=</span> <span class="cn">T</span>,
  useDemographicsEthnicity <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAgeGroup <span class="op">=</span> <span class="cn">T</span>,
  useConditionGroupEraLongTerm <span class="op">=</span> <span class="cn">T</span>, 
  useDrugEraStartLongTerm  <span class="op">=</span> <span class="cn">T</span>, 
  endDays <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>
<span class="op">)</span>

<span class="co"># 4. specify inclusion for data extraction</span>
<span class="co"># we restrict to patients in the target cohort with &gt;=365 days</span>
<span class="co"># observation prior to index and only include patients once </span>
<span class="co"># (the first cohort entry)</span>
<span class="va">restrictPlpDataSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html">createRestrictPlpDataSettings</a></span><span class="op">(</span>
  firstExposureOnly <span class="op">=</span> <span class="cn">T</span>, 
  washoutPeriod <span class="op">=</span> <span class="fl">365</span>
<span class="op">)</span>

<span class="co"># 5. specify inclusion and time-at-risk</span>
<span class="co"># We are predicting the outcome occurring from 1 day after index until</span>
<span class="co"># 730 days after index.  We keep patients who drop out during the </span>
<span class="co"># time-at-risk.</span>
<span class="va">populationSet</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html">createStudyPopulationSettings</a></span><span class="op">(</span>
  requireTimeAtRisk <span class="op">=</span> <span class="cn">F</span>, 
  riskWindowStart <span class="op">=</span> <span class="fl">1</span>, 
  riskWindowEnd <span class="op">=</span> <span class="fl">730</span>
<span class="op">)</span>

<span class="co"># 6. specify the model</span>
<span class="co"># We train a default LASSO logistic regression model</span>
<span class="va">modelSetting</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/setLassoLogisticRegression.html">setLassoLogisticRegression</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># 7. specify the preprocessing</span>
<span class="co"># We use default preprocessing (normalize data and remove rare/redundant covariates)</span>
<span class="va">preprocessSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createPreprocessSettings.html">createPreprocessSettings</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># input these into PatientLevelPrediction::createModelDesign</span>
<span class="co"># this generates a modelDesign object</span>
<span class="va">modelDesign1</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span>
  targetId <span class="op">=</span> <span class="va">targetId</span>,
  outcomeId <span class="op">=</span> <span class="va">outcomeId</span>, 
  restrictPlpDataSettings <span class="op">=</span> <span class="va">restrictPlpDataSettings</span>,
  covariateSettings <span class="op">=</span> <span class="va">covSet</span>, 
  runCovariateSummary <span class="op">=</span> <span class="cn">F</span>,
  modelSettings <span class="op">=</span> <span class="va">modelSetting</span>,
  populationSettings <span class="op">=</span> <span class="va">populationSet</span>, 
  preprocessSettings <span class="op">=</span> <span class="va">preprocessSettings</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="model-design-2" class="section level3">
<h3 class="hasAnchor">
<a href="#model-design-2" class="anchor"></a>Model Design 2</h3>
<p>For the second model we predict the outcome occurring within 2 years of the index date using a gradient boosting machine model with demographic covariates plus conditions/drugs that occur in the year prior to index (but not included index). The only difference between model design 1 and 2 is the model settings:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># example model design 2</span>

<span class="co"># 1. specify the cohort_definition_id for the target cohort</span>
<span class="va">targetId</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># 2. specify the cohort_definition_id for the outcome</span>
<span class="va">outcomeId</span> <span class="op">&lt;-</span> <span class="fl">3</span> 

<span class="co"># 3. specify the covariates</span>
<span class="co"># we include gender, age, race, ethnicity, age in 5 year groups,</span>
<span class="co"># conditions groups (using the vocabulary hierarchy) in the past</span>
<span class="co"># 365 days and drug ingredients in the past 365 days</span>
<span class="co"># we do not include conditions/drugs that occur at index</span>
<span class="va">covSet</span> <span class="op">&lt;-</span> <span class="fu">FeatureExtraction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html">createCovariateSettings</a></span><span class="op">(</span>
  useDemographicsGender <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAge <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsRace <span class="op">=</span> <span class="cn">T</span>,
  useDemographicsEthnicity <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAgeGroup <span class="op">=</span> <span class="cn">T</span>,
  useConditionGroupEraLongTerm <span class="op">=</span> <span class="cn">T</span>, 
  useDrugEraStartLongTerm  <span class="op">=</span> <span class="cn">T</span>, 
  endDays <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>
<span class="op">)</span>

<span class="co"># 4. specify inclusion for data extraction</span>
<span class="co"># we restrict to patients in the target cohort with &gt;=365 days</span>
<span class="co"># observation prior to index and only include patients once </span>
<span class="co"># (the first cohort entry)</span>
<span class="va">restrictPlpDataSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html">createRestrictPlpDataSettings</a></span><span class="op">(</span>
  firstExposureOnly <span class="op">=</span> <span class="cn">T</span>, 
  washoutPeriod <span class="op">=</span> <span class="fl">365</span>
<span class="op">)</span>

<span class="co"># 5. specify inclusion and time-at-risk</span>
<span class="co"># We are predicting the outcome occurring from 1 day after index until</span>
<span class="co"># 730 days after index.  We keep patients who drop out during the </span>
<span class="co"># time-at-risk.</span>
<span class="va">populationSet</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html">createStudyPopulationSettings</a></span><span class="op">(</span>
  requireTimeAtRisk <span class="op">=</span> <span class="cn">F</span>, 
  riskWindowStart <span class="op">=</span> <span class="fl">1</span>, 
  riskWindowEnd <span class="op">=</span> <span class="fl">730</span>
<span class="op">)</span>

<span class="co"># 6. specify the model</span>
<span class="co"># We train a gradient boosting machine with default </span>
<span class="co"># hyper-parameter search</span>
<span class="va">modelSetting</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/setGradientBoostingMachine.html">setGradientBoostingMachine</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># 7. specify the preprocessing</span>
<span class="co"># We use default preprocessing (normalize data and remove rare/redundant covariates)</span>
<span class="va">preprocessSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createPreprocessSettings.html">createPreprocessSettings</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">modelDesign2</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span>
  targetId <span class="op">=</span> <span class="va">targetId</span>,
  outcomeId <span class="op">=</span> <span class="va">outcomeId</span>, 
  restrictPlpDataSettings <span class="op">=</span> <span class="va">restrictPlpDataSettings</span>,
  covariateSettings <span class="op">=</span> <span class="va">covSet</span>, 
  runCovariateSummary <span class="op">=</span> <span class="cn">F</span>,
  modelSettings <span class="op">=</span> <span class="va">modelSetting</span>,
  populationSettings <span class="op">=</span> <span class="va">populationSet</span>, 
  preprocessSettings <span class="op">=</span> <span class="va">preprocessSettings</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="model-design-3" class="section level3">
<h3 class="hasAnchor">
<a href="#model-design-3" class="anchor"></a>Model Design 3</h3>
<p>For the third model we predict the outcome occurring within 2 years of the index date using a LASSO logistic regression model (that includes the intercept in the regularization) with demographic covariates plus conditions/drugs/measurement indicators that occur in the year prior to index (but not included index). The differences between model design 1 and 3 is the inclusion of the intercept in the regularization and the addition of measurement indicator covariates:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># example model design 3</span>

<span class="co"># 1. specify the cohort_definition_id for the target cohort</span>
<span class="va">targetId</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># 2. specify the cohort_definition_id for the outcome</span>
<span class="va">outcomeId</span> <span class="op">&lt;-</span> <span class="fl">3</span> 

<span class="co"># 3. specify the covariates</span>
<span class="co"># we include gender, age, race, ethnicity, age in 5 year groups,</span>
<span class="co"># conditions groups (using the vocabulary hierarchy) in the past</span>
<span class="co"># 365 days and drug ingredients in the past 365 days</span>
<span class="co"># we do not include conditions/drugs that occur at index</span>
<span class="co"># we also include measurements indicators in the past 365 days</span>
<span class="va">covSet</span> <span class="op">&lt;-</span> <span class="fu">FeatureExtraction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html">createCovariateSettings</a></span><span class="op">(</span>
  useDemographicsGender <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAge <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsRace <span class="op">=</span> <span class="cn">T</span>,
  useDemographicsEthnicity <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAgeGroup <span class="op">=</span> <span class="cn">T</span>,
  useConditionGroupEraLongTerm <span class="op">=</span> <span class="cn">T</span>, 
  useDrugEraStartLongTerm  <span class="op">=</span> <span class="cn">T</span>, 
  useMeasurementLongTerm <span class="op">=</span> <span class="cn">T</span>,
  endDays <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>
<span class="op">)</span>

<span class="co"># 4. specify inclusion for data extraction</span>
<span class="co"># we restrict to patients in the target cohort with &gt;=365 days</span>
<span class="co"># observation prior to index and only include patients once </span>
<span class="co"># (the first cohort entry)</span>
<span class="va">restrictPlpDataSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html">createRestrictPlpDataSettings</a></span><span class="op">(</span>
  firstExposureOnly <span class="op">=</span> <span class="cn">T</span>, 
  washoutPeriod <span class="op">=</span> <span class="fl">365</span>
<span class="op">)</span>

<span class="co"># 5. specify inclusion and time-at-risk</span>
<span class="co"># We are predicting the outcome occurring from 1 day after index until</span>
<span class="co"># 730 days after index.  We keep patients who drop out during the </span>
<span class="co"># time-at-risk.</span>
<span class="va">populationSet</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html">createStudyPopulationSettings</a></span><span class="op">(</span>
  requireTimeAtRisk <span class="op">=</span> <span class="cn">F</span>, 
  riskWindowStart <span class="op">=</span> <span class="fl">1</span>, 
  riskWindowEnd <span class="op">=</span> <span class="fl">730</span>
<span class="op">)</span>

<span class="co"># 6. specify the model</span>
<span class="co"># We train a LASSO logistic regression model but include the </span>
<span class="co"># intercept in the regularization</span>
<span class="va">modelSetting</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/setLassoLogisticRegression.html">setLassoLogisticRegression</a></span><span class="op">(</span>
  forceIntercept <span class="op">=</span> <span class="cn">T</span>
  <span class="op">)</span>

<span class="co"># 7. specify the preprocessing</span>
<span class="co"># We use default preprocessing (normalize data and remove rare/redundant covariates)</span>
<span class="va">preprocessSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createPreprocessSettings.html">createPreprocessSettings</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">modelDesign3</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span>
  targetId <span class="op">=</span> <span class="va">targetId</span>,
  outcomeId <span class="op">=</span> <span class="va">outcomeId</span>, 
  restrictPlpDataSettings <span class="op">=</span> <span class="va">restrictPlpDataSettings</span>,
  covariateSettings <span class="op">=</span> <span class="va">covSet</span>, 
  runCovariateSummary <span class="op">=</span> <span class="cn">F</span>,
  modelSettings <span class="op">=</span> <span class="va">modelSetting</span>,
  populationSettings <span class="op">=</span> <span class="va">populationSet</span>, 
  preprocessSettings <span class="op">=</span> <span class="va">preprocessSettings</span>
<span class="op">)</span></code></pre></div>
<p>In this example we use three base models, but it is possible to add as many base models as desired.</p>
</div>
<div id="ensemble-strategy" class="section level3">
<h3 class="hasAnchor">
<a href="#ensemble-strategy" class="anchor"></a>Ensemble Strategy</h3>
<p>Once you have specified the databaseDetails and defined all the base model designs, the next step is specifying the split settings (how much data will be used to develop each base model and how much is used to test the base models/ensemble) and the ensemble strategy, consisting of a filtering setting and a combination setting.</p>
<p>The default split settings is <code><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createDefaultSplitSetting.html">PatientLevelPrediction::createDefaultSplitSetting()</a></code> splits the data randomly (by stratified by outcome label) into 25% test data and 75% train data. The train data is split into 3 folds for cross validation. This is a suitable split for most ensembles.</p>
<p>In this example we use the default split settings:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">splitSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createDefaultSplitSetting.html">createDefaultSplitSetting</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>The filter settings specify criteria for including a base model in the ensemble. It is a list with the options:</p>
<ol style="list-style-type: decimal">
<li>
<code>metric</code> - the metric to use when extracting the internal performance</li>
<li>
<code>evaluation</code> - either ‘CV’ or ‘Train’ specifying which internal performance evaluation type to use</li>
<li>
<code>minValue</code> - if this is set then a base model’s <code>metric</code> for the <code>evaluation</code> is extracted and the base model is included into the ensemble if this value is greater or equal to <code>minValue</code>.</li>
<li>
<code>maxValue</code> - if this is set then a base model’s <code>metric</code> for the <code>evaluation</code> is extracted and the base model is included into the ensemble if this value is lesser or equal to <code>maxValue</code>.</li>
</ol>
<p>In this example we will only include base models where the internal cross validation AUROC is between 0.5 and 1:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filterSettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    metric <span class="op">=</span> <span class="st">'AUROC'</span>,
    evaluation <span class="op">=</span> <span class="st">'CV'</span>,
    minValue <span class="op">=</span> <span class="fl">0.5</span>, 
    maxValue <span class="op">=</span> <span class="fl">1</span>
    <span class="op">)</span></code></pre></div>
<p>The final setting is how to combine the base model that pass the filter. This is specified by creating a <code>combinerSettings</code> object. This can be create in a custom way, or you can select from some default functions to create this. The main one is: <code><a href="../reference/createFusionCombiner.html">EnsemblePatientLevelPrediction::createFusionCombiner</a></code> that can do uniform weights or weights based on internal validation metrics.</p>
<p>The specify a combiner that takes the mean of all the included base model predictions, pick <code>type = uniform</code> and <code>scaleFunction = 'normalize'</code>. Alternatively, if you wished to weight the base models based on internal validation performance, you need to specify the <code>evaluation</code> where you can select ‘CV’ or ‘Train’. Then you need to specify the metric <code>type</code> (e.g., <code>type = 'AUROC'</code> or <code>type = 'AUPRC'</code>). The <code>scaleFunction = 'normalize'</code> makes sure the weights add to 1.</p>
<p>In this example we will use equal weighting for the base models but want to make sure the weights add up to 1, so we pick:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">combinerSettings</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/createFusionCombiner.html">createFusionCombiner</a></span><span class="op">(</span>
    type <span class="op">=</span> <span class="st">'uniform'</span>,
    scaleFunction <span class="op">=</span> <span class="st">'normalize'</span>
  <span class="op">)</span></code></pre></div>
<p>Finally, putting all these together, we run the <code><a href="../reference/setEnsembleFromDesign.html">EnsemblePatientLevelPrediction::setEnsembleFromDesign()</a></code> function to create the ensemble settings:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ensembleSettings</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/setEnsembleFromDesign.html">setEnsembleFromDesign</a></span><span class="op">(</span>
  modelDesignList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">modelDesign1</span>, <span class="va">modelDesign2</span>, <span class="va">modelDesign3</span><span class="op">)</span>,
  databaseDetails <span class="op">=</span> <span class="va">databaseDetails</span>,
  splitSettings <span class="op">=</span> <span class="va">splitSettings</span>,
  filterSettings <span class="op">=</span> <span class="va">filterSettings</span>,
  combinerSettings <span class="op">=</span> <span class="va">combinerSettings</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="running-the-ensemble-development" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-ensemble-development" class="anchor"></a>Running The Ensemble Development</h3>
<p>The final step is now running the ensemble development. This requires the ensemble setting, a log setting (specifying what progress text is output during the ensemble development) and the location to save the ensemble. In this example we use the previously specified ensemble settings, we create a log setting named ‘ensemble’ and we save the ensemble to a directory named ‘testingEnsemble’ within the current working directory.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ensemble</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/runEnsemble.html">runEnsemble</a></span><span class="op">(</span>
  ensembleSettings <span class="op">=</span> <span class="va">ensembleSettings</span>,
  logSettings <span class="op">=</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createLogSettings.html">createLogSettings</a></span><span class="op">(</span>logName <span class="op">=</span> <span class="st">'ensemble'</span><span class="op">)</span>,
  saveDirectory <span class="op">=</span> <span class="st">'./testingEnsemble'</span>
<span class="op">)</span></code></pre></div>
<p>If all the settings are specified correctly, you will see progress text telling you the data are being extracted, then telling you each base model is being developed and finally telling you the evaluation of the base models and the ensemble. The result will be <code>ensemble</code> that is an object of class <code>plpEnsemble</code> containing:</p>
<ol style="list-style-type: decimal">
<li>model - the ensemble model</li>
<li>prediction - a data.frame with the predictions for the ensemble and base models</li>
<li>performanceEvaluation - a list of objects with the internal validation of the base models and ensemble</li>
<li>analysisSettings - the analysisId for the ensemble</li>
<li>executionSettings - information about the execution of the ensemble development</li>
</ol>
<p>The function <code><a href="../reference/runEnsemble.html">EnsemblePatientLevelPrediction::runEnsemble()</a></code> will save the ensemble result in the directory specified by <code>saveDirectory</code>, but you can save it somewhere else by running:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/saveEnsemble.html">saveEnsemble</a></span><span class="op">(</span>
  <span class="va">ensemble</span>,
  <span class="st">'C:/any/location/here'</span>
<span class="op">)</span></code></pre></div>
</div>
</div>
<div id="example-2-developing-a-stacker-ensemble-using-a-list-of-model-designs" class="section level2">
<h2 class="hasAnchor">
<a href="#example-2-developing-a-stacker-ensemble-using-a-list-of-model-designs" class="anchor"></a>Example 2: Developing a stacker ensemble using a list of model designs</h2>
<p>In this example we will show you how to develop a stacker ensemble from scratch using an OMOP CDM database connection and model designs (created using the <a href="http://github.com/OHDSI/PatientLevelPrediction"><code>PatientLevelPrediction</code></a> createModelDesign() function).</p>
<div id="database-connection-1" class="section level3">
<h3 class="hasAnchor">
<a href="#database-connection-1" class="anchor"></a>Database connection</h3>
<p>We will use the <code>Eunomia</code> R package that contains an sql lite database with data in the OMOP CDM format for demonstration.</p>
<p>The following code initiates the Eunomia OMOP CDM database, configures the connectionDetails and then uses the <code>createDatabaseDetails()</code> in PatientLevelPrediction to specify where the data required when developing a prediction are found:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/createCohorts.html">createCohorts</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span>

<span class="va">databaseDetails</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createDatabaseDetails.html">createDatabaseDetails</a></span><span class="op">(</span>
  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>, 
  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,
  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>, 
  cohortTable <span class="op">=</span> <span class="st">"cohort"</span>, 
  cohortId <span class="op">=</span> <span class="fl">4</span>, 
  outcomeIds <span class="op">=</span> <span class="fl">3</span>,
  outcomeDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>, 
  outcomeTable <span class="op">=</span>  <span class="st">"cohort"</span>, 
  cdmDatabaseName <span class="op">=</span> <span class="st">'eunomia'</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="base-model-design-1" class="section level3">
<h3 class="hasAnchor">
<a href="#base-model-design-1" class="anchor"></a>Base Model Design</h3>
<p>The next step is designing the models that we wish to potentially combine via an ensemble. To do this, we use the <code>createModelDesign()</code> function in PatientLevelPrediction. This requires:</p>
<ol style="list-style-type: decimal">
<li>Specifying the cohortId for the target population</li>
<li>Specifying the outcomeId for the outcome</li>
<li>A specification of the candidate covariates (created using <code><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html">FeatureExtraction::createCovariateSettings()</a></code>) that will be used by the model.</li>
<li>Any inclusion criteria implemented at data extraction specified via the <code><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html">PatientLevelPrediction::createRestrictPlpDataSettings()</a></code> such as minimum observation time in the database (washoutPeriod) or whether the include patients multiple times in the data or restrict to the first cohort entry (firstExposureOnly).</li>
<li>Any inclusion criteria implemented after data extraction that can be specified via the <code><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html">PatientLevelPrediction::createStudyPopulationSettings()</a></code> and specifications for the time-at-risk period to determine the outcome labels.</li>
<li>The model settings the specify which classifier/survival model to train and the hyper-parameter search.</li>
<li>The preprocessing settings specified by <code><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createPreprocessSettings.html">PatientLevelPrediction::createPreprocessSettings()</a></code> where you can pick whether to normalize the data or remove rare/redundant covariates.</li>
</ol>
<p>You can also optionally specify feature engineering settings and data sampling settings (e.g., over/under sampling).</p>
</div>
<div id="model-design-1-1" class="section level3">
<h3 class="hasAnchor">
<a href="#model-design-1-1" class="anchor"></a>Model Design 1</h3>
<p>For the first model we predict the outcome occurring within 2 years of the index date using a LASSO logistic regression model with demographic covariates plus conditions/drugs that occur in the year prior to index (but not included index):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># example model design 1</span>

<span class="co"># 1. specify the cohort_definition_id for the target cohort</span>
<span class="va">targetId</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># 2. specify the cohort_definition_id for the outcome</span>
<span class="va">outcomeId</span> <span class="op">&lt;-</span> <span class="fl">3</span> 

<span class="co"># 3. specify the covariates</span>
<span class="co"># we include gender, age, race, ethnicity, age in 5 year groups,</span>
<span class="co"># conditions groups (using the vocabulary hierarchy) in the past</span>
<span class="co"># 365 days and drug ingredients in the past 365 days</span>
<span class="co"># we do not include conditions/drugs that occur at index</span>
<span class="va">covSet</span> <span class="op">&lt;-</span> <span class="fu">FeatureExtraction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html">createCovariateSettings</a></span><span class="op">(</span>
  useDemographicsGender <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAge <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsRace <span class="op">=</span> <span class="cn">T</span>,
  useDemographicsEthnicity <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAgeGroup <span class="op">=</span> <span class="cn">T</span>,
  useConditionGroupEraLongTerm <span class="op">=</span> <span class="cn">T</span>, 
  useDrugEraStartLongTerm  <span class="op">=</span> <span class="cn">T</span>, 
  endDays <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>
<span class="op">)</span>

<span class="co"># 4. specify inclusion for data extraction</span>
<span class="co"># we restrict to patients in the target cohort with &gt;=365 days</span>
<span class="co"># observation prior to index and only include patients once </span>
<span class="co"># (the first cohort entry)</span>
<span class="va">restrictPlpDataSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html">createRestrictPlpDataSettings</a></span><span class="op">(</span>
  firstExposureOnly <span class="op">=</span> <span class="cn">T</span>, 
  washoutPeriod <span class="op">=</span> <span class="fl">365</span>
<span class="op">)</span>

<span class="co"># 5. specify inclusion and time-at-risk</span>
<span class="co"># We are predicting the outcome occurring from 1 day after index until</span>
<span class="co"># 730 days after index.  We keep patients who drop out during the </span>
<span class="co"># time-at-risk.</span>
<span class="va">populationSet</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html">createStudyPopulationSettings</a></span><span class="op">(</span>
  requireTimeAtRisk <span class="op">=</span> <span class="cn">F</span>, 
  riskWindowStart <span class="op">=</span> <span class="fl">1</span>, 
  riskWindowEnd <span class="op">=</span> <span class="fl">730</span>
<span class="op">)</span>

<span class="co"># 6. specify the model</span>
<span class="co"># We train a default LASSO logistic regression model</span>
<span class="va">modelSetting</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/setLassoLogisticRegression.html">setLassoLogisticRegression</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># 7. specify the preprocessing</span>
<span class="co"># We use default preprocessing (normalize data and remove rare/redundant covariates)</span>
<span class="va">preprocessSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createPreprocessSettings.html">createPreprocessSettings</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># input these into PatientLevelPrediction::createModelDesign</span>
<span class="co"># this generates a modelDesign object</span>
<span class="va">modelDesign1</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span>
  targetId <span class="op">=</span> <span class="va">targetId</span>,
  outcomeId <span class="op">=</span> <span class="va">outcomeId</span>, 
  restrictPlpDataSettings <span class="op">=</span> <span class="va">restrictPlpDataSettings</span>,
  covariateSettings <span class="op">=</span> <span class="va">covSet</span>, 
  runCovariateSummary <span class="op">=</span> <span class="cn">F</span>,
  modelSettings <span class="op">=</span> <span class="va">modelSetting</span>,
  populationSettings <span class="op">=</span> <span class="va">populationSet</span>, 
  preprocessSettings <span class="op">=</span> <span class="va">preprocessSettings</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="model-design-2-1" class="section level3">
<h3 class="hasAnchor">
<a href="#model-design-2-1" class="anchor"></a>Model Design 2</h3>
<p>For the second model we predict the outcome occurring within 2 years of the index date using a gradient boosting machine model with demographic covariates plus conditions/drugs that occur in the year prior to index (but not included index). The only difference between model design 1 and 2 is the model settings:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># example model design 2</span>

<span class="co"># 1. specify the cohort_definition_id for the target cohort</span>
<span class="va">targetId</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># 2. specify the cohort_definition_id for the outcome</span>
<span class="va">outcomeId</span> <span class="op">&lt;-</span> <span class="fl">3</span> 

<span class="co"># 3. specify the covariates</span>
<span class="co"># we include gender, age, race, ethnicity, age in 5 year groups,</span>
<span class="co"># conditions groups (using the vocabulary hierarchy) in the past</span>
<span class="co"># 365 days and drug ingredients in the past 365 days</span>
<span class="co"># we do not include conditions/drugs that occur at index</span>
<span class="va">covSet</span> <span class="op">&lt;-</span> <span class="fu">FeatureExtraction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html">createCovariateSettings</a></span><span class="op">(</span>
  useDemographicsGender <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAge <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsRace <span class="op">=</span> <span class="cn">T</span>,
  useDemographicsEthnicity <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAgeGroup <span class="op">=</span> <span class="cn">T</span>,
  useConditionGroupEraLongTerm <span class="op">=</span> <span class="cn">T</span>, 
  useDrugEraStartLongTerm  <span class="op">=</span> <span class="cn">T</span>, 
  endDays <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>
<span class="op">)</span>

<span class="co"># 4. specify inclusion for data extraction</span>
<span class="co"># we restrict to patients in the target cohort with &gt;=365 days</span>
<span class="co"># observation prior to index and only include patients once </span>
<span class="co"># (the first cohort entry)</span>
<span class="va">restrictPlpDataSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html">createRestrictPlpDataSettings</a></span><span class="op">(</span>
  firstExposureOnly <span class="op">=</span> <span class="cn">T</span>, 
  washoutPeriod <span class="op">=</span> <span class="fl">365</span>
<span class="op">)</span>

<span class="co"># 5. specify inclusion and time-at-risk</span>
<span class="co"># We are predicting the outcome occurring from 1 day after index until</span>
<span class="co"># 730 days after index.  We keep patients who drop out during the </span>
<span class="co"># time-at-risk.</span>
<span class="va">populationSet</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html">createStudyPopulationSettings</a></span><span class="op">(</span>
  requireTimeAtRisk <span class="op">=</span> <span class="cn">F</span>, 
  riskWindowStart <span class="op">=</span> <span class="fl">1</span>, 
  riskWindowEnd <span class="op">=</span> <span class="fl">730</span>
<span class="op">)</span>

<span class="co"># 6. specify the model</span>
<span class="co"># We train a gradient boosting machine with default </span>
<span class="co"># hyper-parameter search</span>
<span class="va">modelSetting</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/setGradientBoostingMachine.html">setGradientBoostingMachine</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># 7. specify the preprocessing</span>
<span class="co"># We use default preprocessing (normalize data and remove rare/redundant covariates)</span>
<span class="va">preprocessSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createPreprocessSettings.html">createPreprocessSettings</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">modelDesign2</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span>
  targetId <span class="op">=</span> <span class="va">targetId</span>,
  outcomeId <span class="op">=</span> <span class="va">outcomeId</span>, 
  restrictPlpDataSettings <span class="op">=</span> <span class="va">restrictPlpDataSettings</span>,
  covariateSettings <span class="op">=</span> <span class="va">covSet</span>, 
  runCovariateSummary <span class="op">=</span> <span class="cn">F</span>,
  modelSettings <span class="op">=</span> <span class="va">modelSetting</span>,
  populationSettings <span class="op">=</span> <span class="va">populationSet</span>, 
  preprocessSettings <span class="op">=</span> <span class="va">preprocessSettings</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="model-design-3-1" class="section level3">
<h3 class="hasAnchor">
<a href="#model-design-3-1" class="anchor"></a>Model Design 3</h3>
<p>For the third model we predict the outcome occurring within 2 years of the index date using a LASSO logistic regression model (that includes the intercept in the regularization) with demographic covariates plus conditions/drugs/measurement indicators that occur in the year prior to index (but not included index). The differences between model design 1 and 3 is the inclusion of the intercept in the regularization and the addition of measurement indicator covariates:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># example model design 3</span>

<span class="co"># 1. specify the cohort_definition_id for the target cohort</span>
<span class="va">targetId</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># 2. specify the cohort_definition_id for the outcome</span>
<span class="va">outcomeId</span> <span class="op">&lt;-</span> <span class="fl">3</span> 

<span class="co"># 3. specify the covariates</span>
<span class="co"># we include gender, age, race, ethnicity, age in 5 year groups,</span>
<span class="co"># conditions groups (using the vocabulary hierarchy) in the past</span>
<span class="co"># 365 days and drug ingredients in the past 365 days</span>
<span class="co"># we do not include conditions/drugs that occur at index</span>
<span class="co"># we also include measurements indicators in the past 365 days</span>
<span class="va">covSet</span> <span class="op">&lt;-</span> <span class="fu">FeatureExtraction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html">createCovariateSettings</a></span><span class="op">(</span>
  useDemographicsGender <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAge <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsRace <span class="op">=</span> <span class="cn">T</span>,
  useDemographicsEthnicity <span class="op">=</span> <span class="cn">T</span>, 
  useDemographicsAgeGroup <span class="op">=</span> <span class="cn">T</span>,
  useConditionGroupEraLongTerm <span class="op">=</span> <span class="cn">T</span>, 
  useDrugEraStartLongTerm  <span class="op">=</span> <span class="cn">T</span>, 
  useMeasurementLongTerm <span class="op">=</span> <span class="cn">T</span>,
  endDays <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>
<span class="op">)</span>

<span class="co"># 4. specify inclusion for data extraction</span>
<span class="co"># we restrict to patients in the target cohort with &gt;=365 days</span>
<span class="co"># observation prior to index and only include patients once </span>
<span class="co"># (the first cohort entry)</span>
<span class="va">restrictPlpDataSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html">createRestrictPlpDataSettings</a></span><span class="op">(</span>
  firstExposureOnly <span class="op">=</span> <span class="cn">T</span>, 
  washoutPeriod <span class="op">=</span> <span class="fl">365</span>
<span class="op">)</span>

<span class="co"># 5. specify inclusion and time-at-risk</span>
<span class="co"># We are predicting the outcome occurring from 1 day after index until</span>
<span class="co"># 730 days after index.  We keep patients who drop out during the </span>
<span class="co"># time-at-risk.</span>
<span class="va">populationSet</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html">createStudyPopulationSettings</a></span><span class="op">(</span>
  requireTimeAtRisk <span class="op">=</span> <span class="cn">F</span>, 
  riskWindowStart <span class="op">=</span> <span class="fl">1</span>, 
  riskWindowEnd <span class="op">=</span> <span class="fl">730</span>
<span class="op">)</span>

<span class="co"># 6. specify the model</span>
<span class="co"># We train a LASSO logistic regression model but include the </span>
<span class="co"># intercept in the regularization</span>
<span class="va">modelSetting</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/setLassoLogisticRegression.html">setLassoLogisticRegression</a></span><span class="op">(</span>
  forceIntercept <span class="op">=</span> <span class="cn">T</span>
  <span class="op">)</span>

<span class="co"># 7. specify the preprocessing</span>
<span class="co"># We use default preprocessing (normalize data and remove rare/redundant covariates)</span>
<span class="va">preprocessSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createPreprocessSettings.html">createPreprocessSettings</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">modelDesign3</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span>
  targetId <span class="op">=</span> <span class="va">targetId</span>,
  outcomeId <span class="op">=</span> <span class="va">outcomeId</span>, 
  restrictPlpDataSettings <span class="op">=</span> <span class="va">restrictPlpDataSettings</span>,
  covariateSettings <span class="op">=</span> <span class="va">covSet</span>, 
  runCovariateSummary <span class="op">=</span> <span class="cn">F</span>,
  modelSettings <span class="op">=</span> <span class="va">modelSetting</span>,
  populationSettings <span class="op">=</span> <span class="va">populationSet</span>, 
  preprocessSettings <span class="op">=</span> <span class="va">preprocessSettings</span>
<span class="op">)</span></code></pre></div>
<p>In this example we use three base models, but it is possible to add as many base models as desired.</p>
</div>
<div id="ensemble-strategy-1" class="section level3">
<h3 class="hasAnchor">
<a href="#ensemble-strategy-1" class="anchor"></a>Ensemble Strategy</h3>
<p>Once you have specified the databaseDetails and defined all the base model designs, the next step is specifying the split settings (how much data will be used to develop each base model and how much is used to test the base models/ensemble) and the ensemble strategy, consisting of a filtering setting and a combination setting.</p>
<p>As we are using a stacker, we will split the data into: - training data for the level 1 base models - training data for the level 2 stacker model - testing data for the ensemble</p>
<p>The default split settings <code><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createDefaultSplitSetting.html">PatientLevelPrediction::createDefaultSplitSetting()</a></code> splits the data randomly (by stratified by outcome label) into 25% test data and 75% train data. The train data is split into 3 folds for cross validation.</p>
<p>For the stacker, the train data will be used by the level 1 base models and the test data will further split into data used to train the level 2 stacker model and the remaining will be used perform internal validation for the ensemble. Therefore, we will split the data into 50% level 1 training data and 50% test data (that will be split into 25% level 2 training data and 25% ensemble test data based on the input to <code><a href="../reference/createStackerCombiner.html">createStackerCombiner()</a></code>)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">splitSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createDefaultSplitSetting.html">createDefaultSplitSetting</a></span><span class="op">(</span>
  testFraction <span class="op">=</span> <span class="fl">0.5</span>, 
  trainFraction <span class="op">=</span> <span class="fl">0.5</span>
  <span class="op">)</span></code></pre></div>
<p>The filter settings specify criteria for including a base model in the ensemble. It is a list with the options:</p>
<ol style="list-style-type: decimal">
<li>
<code>metric</code> - the metric to use when extracting the internal performance</li>
<li>
<code>evaluation</code> - either ‘CV’ or ‘Train’ specifying which internal performance evaluation type to use</li>
<li>
<code>minValue</code> - if this is set then a base model’s <code>metric</code> for the <code>evaluation</code> is extracted and the base model is included into the ensemble if this value is greater or equal to <code>minValue</code>.</li>
<li>
<code>maxValue</code> - if this is set then a base model’s <code>metric</code> for the <code>evaluation</code> is extracted and the base model is included into the ensemble if this value is lesser or equal to <code>maxValue</code>.</li>
</ol>
<p>In this example we will only include base models where the internal cross validation AUROC is between 0.5 and 1:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filterSettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    metric <span class="op">=</span> <span class="st">'AUROC'</span>,
    evaluation <span class="op">=</span> <span class="st">'CV'</span>,
    minValue <span class="op">=</span> <span class="fl">0.5</span>, 
    maxValue <span class="op">=</span> <span class="fl">1</span>
    <span class="op">)</span></code></pre></div>
<p>The final setting is how to combine the base model that pass the filter. This is specified by creating a <code>combinerSettings</code> object. This can be create in a custom way, or you can select from some default functions to create this. The default stacker function is: <code><a href="../reference/createStackerCombiner.html">EnsemblePatientLevelPrediction::createStackerCombiner</a></code>.</p>
<p>The inputs for the <code><a href="../reference/createStackerCombiner.html">EnsemblePatientLevelPrediction::createStackerCombiner</a></code> are:</p>
<ul>
<li>a string <code>levelTwoType</code> that corresponds to the classifier that will be used to learn to combine the level 1 base predictions. Currently only ‘logisticRegressionStacker’ a logistic model stacker is supported.<br>
</li>
<li>a list <code>levelTwoHyperparameters</code> containing any hyper-parameters for the level two stacker. For ‘logisticRegressionStacker’ this is NULL as there are no hyper-parameters for logistic regression.</li>
<li>a list <code>levelTwoDataSettings</code> that specifies whether the stacker will be learned using the ‘CV’ predictions or ‘Test’ predictions. If using ‘Test’ then a proportion is requires to specify what proprotion of the ‘Test’ predictions will be used to learn the level 2 stacker model and the remainingn ‘Test’ predictions will be used to calculate the internal validation performance.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">combinerSettings</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/createStackerCombiner.html">createStackerCombiner</a></span><span class="op">(</span>
  levelTwoType <span class="op">=</span> <span class="st">'logisticRegressionStacker'</span>,
  levelTwoDataSettings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    type <span class="op">=</span> <span class="st">'Test'</span>, 
    proportion <span class="op">=</span> <span class="fl">0.5</span>
    <span class="op">)</span>
<span class="op">)</span>

<span class="co"># if you have smaller data and you dont want to split the Test data into two, you can train the stacker on the CV predictions using:</span>

<span class="va">combinerSettings2</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/createStackerCombiner.html">createStackerCombiner</a></span><span class="op">(</span>
  levelTwoType <span class="op">=</span> <span class="st">'logisticRegressionStacker'</span>,
  levelTwoDataSettings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'CV'</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Finally, putting all these together, we run the <code><a href="../reference/setEnsembleFromDesign.html">EnsemblePatientLevelPrediction::setEnsembleFromDesign()</a></code> function to create the ensemble settings:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ensembleSettings</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/setEnsembleFromDesign.html">setEnsembleFromDesign</a></span><span class="op">(</span>
  modelDesignList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">modelDesign1</span>, <span class="va">modelDesign2</span>, <span class="va">modelDesign3</span><span class="op">)</span>,
  databaseDetails <span class="op">=</span> <span class="va">databaseDetails</span>,
  splitSettings <span class="op">=</span> <span class="va">splitSettings</span>,
  filterSettings <span class="op">=</span> <span class="va">filterSettings</span>,
  combinerSettings <span class="op">=</span> <span class="va">combinerSettings</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="running-the-ensemble-development-1" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-ensemble-development-1" class="anchor"></a>Running The Ensemble Development</h3>
<p>The final step is now running the ensemble development. This requires the ensemble setting, a log setting (specifying what progress text is output during the ensemble development) and the location to save the ensemble. In this example we use the previously specified ensemble settings, we create a log setting named ‘ensemble’ and we save the ensemble to a directory named ‘testingEnsemble’ within the current working directory.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ensemble</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/runEnsemble.html">runEnsemble</a></span><span class="op">(</span>
  ensembleSettings <span class="op">=</span> <span class="va">ensembleSettings</span>,
  logSettings <span class="op">=</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createLogSettings.html">createLogSettings</a></span><span class="op">(</span>logName <span class="op">=</span> <span class="st">'ensemble'</span><span class="op">)</span>,
  saveDirectory <span class="op">=</span> <span class="st">'./testingEnsemble'</span>
<span class="op">)</span></code></pre></div>
<p>If all the settings are specified correctly, you will see progress text telling you the data are being extracted, then telling you each base model is being developed and finally telling you the evaluation of the base models and the ensemble. The result will be <code>ensemble</code> that is an object of class <code>plpEnsemble</code> containing:</p>
<ol style="list-style-type: decimal">
<li>model - the ensemble model</li>
<li>prediction - a data.frame with the predictions for the ensemble and base models</li>
<li>performanceEvaluation - a list of objects with the internal validation of the base models and ensemble</li>
<li>analysisSettings - the analysisId for the ensemble</li>
<li>executionSettings - information about the execution of the ensemble development</li>
</ol>
<p>The function <code><a href="../reference/runEnsemble.html">EnsemblePatientLevelPrediction::runEnsemble()</a></code> will save the ensemble result in the directory specified by <code>saveDirectory</code>, but you can save it somewhere else by running:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/saveEnsemble.html">saveEnsemble</a></span><span class="op">(</span>
  <span class="va">ensemble</span>,
  <span class="st">'C:/any/location/here'</span>
<span class="op">)</span></code></pre></div>
</div>
</div>
<div id="example-3-developing-a-fusion-ensemble-using-a-list-of-runplp-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#example-3-developing-a-fusion-ensemble-using-a-list-of-runplp-objects" class="anchor"></a>Example 3: Developing a Fusion ensemble using a list of runPlp objects</h2>
<p>In this example we show you how you can develop an ensemble using previously developed base models (maybe you have developed models previously and wish to combine them). This can be used to combine models developed using different databases.</p>
<p>You will need:</p>
<ul>
<li>A list of runPlp objects created using the <a href="http://github.com/OHDSI/PatientLevelPrediction"><code>PatientLevelPrediction</code></a> runPlp() function. The runPlp objects containing the prediction models you wish to combine and their internal validation performances.</li>
</ul>
<div id="creating-the-resultlist" class="section level3">
<h3 class="hasAnchor">
<a href="#creating-the-resultlist" class="anchor"></a>Creating the resultList</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># if you have a runPLP result at runPlpLocation1, load it into R</span>
<span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/loadPlpResult.html">loadPlpResult</a></span><span class="op">(</span><span class="va">runPlpLocation1</span><span class="op">)</span>

<span class="co"># if you have a runPLP result at runPlpLocation2, load it into R</span>
<span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/loadPlpResult.html">loadPlpResult</a></span><span class="op">(</span><span class="va">runPlpLocation2</span><span class="op">)</span>

<span class="co"># if you have a runPLP result at runPlpLocation3, load it into R</span>
<span class="va">result3</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/loadPlpResult.html">loadPlpResult</a></span><span class="op">(</span><span class="va">runPlpLocation3</span><span class="op">)</span>

<span class="co"># if you have a runPLP result at runPlpLocation4, load it into R</span>
<span class="va">result4</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/loadPlpResult.html">loadPlpResult</a></span><span class="op">(</span><span class="va">runPlpLocation4</span><span class="op">)</span>

<span class="va">resultList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="va">result1</span>,
  <span class="va">result2</span>,
  <span class="va">result3</span>,
  <span class="va">result4</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="ensemble-strategy-2" class="section level3">
<h3 class="hasAnchor">
<a href="#ensemble-strategy-2" class="anchor"></a>Ensemble Strategy</h3>
<p>Once you have the resultList you then need to specify the ensemble strategy, consisting of a filtering setting and a combination setting.</p>
<p>The filter settings specify criteria for including a base model in the ensemble. It is a list with the options:</p>
<ol style="list-style-type: decimal">
<li>
<code>metric</code> - the metric to use when exrtracting the internal performance</li>
<li>
<code>evaluation</code> - either ‘CV’ or ‘Train’ specifying which internal performance evaluation type to use</li>
<li>
<code>minValue</code> - if this is set then a base model’s <code>metric</code> for the <code>evaluation</code> is extracted and the base model is included into the ensemble if this value is greater or equal to <code>minValue</code>.</li>
<li>
<code>maxValue</code> - if this is set then a base model’s <code>metric</code> for the <code>evaluation</code> is extracted and the base model is included into the ensemble if this value is lesser or equal to <code>maxValue</code>.</li>
</ol>
<p>In this example we will only include base models where the internal cross validation AUROC is between 0.5 and 1:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filterSettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    metric <span class="op">=</span> <span class="st">'AUROC'</span>,
    evaluation <span class="op">=</span> <span class="st">'CV'</span>,
    minValue <span class="op">=</span> <span class="fl">0.5</span>, 
    maxValue <span class="op">=</span> <span class="fl">1</span>
    <span class="op">)</span></code></pre></div>
<p>The final setting is how to combine the base model that pass the filter. This is specified by creating a <code>combinerSettings</code> object. This can be create in a custom way, or you can select from some default functions to create this. The main one is: <code><a href="../reference/createFusionCombiner.html">EnsemblePatientLevelPrediction::createFusionCombiner</a></code> that can do uniform weights or weights based on internal validation metrics.</p>
<p>The specify a combiner that takes the mean of all the included base model predictions, pick <code>type = uniform</code> and <code>scaleFunction = 'normalize'</code>. Alternatively, if you wished to weight the base models based on internal validation performance, you need to specify the <code>evaluation</code> where you can select ‘CV’ or ‘Train’. Then you need to specify the metric <code>type</code> (e.g., <code>type = 'AUROC'</code> or <code>type = 'AUPRC'</code>). The <code>scaleFunction = 'normalize'</code> makes sure the weights add to 1.</p>
<p>In this example we will use normalized AUROC based on cross validation weighting for the base models but want to make sure the weights add up to 1, so we pick:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">combinerSettings</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/createFusionCombiner.html">createFusionCombiner</a></span><span class="op">(</span>
    type <span class="op">=</span> <span class="st">'AUROC'</span>,
    evaluation <span class="op">=</span> <span class="st">'CV'</span>,
    scaleFunction <span class="op">=</span> <span class="st">'normalize'</span>
  <span class="op">)</span></code></pre></div>
<p>Finally, putting all these together, we run the <code><a href="../reference/setEnsembleFromDesign.html">EnsemblePatientLevelPrediction::setEnsembleFromDesign()</a></code> function to create the ensemble settings:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ensembleSettings</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/setEnsembleFromResults.html">setEnsembleFromResults</a></span><span class="op">(</span>
  resultList <span class="op">=</span> <span class="va">resultList</span>,
  filterSettings <span class="op">=</span> <span class="va">filterSettings</span>,
  combinerSettings <span class="op">=</span> <span class="va">combinerSettings</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="running-the-ensemble-development-2" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-ensemble-development-2" class="anchor"></a>Running The Ensemble Development</h3>
<p>The final step is now running the ensemble development. This requires the ensemble setting, a log setting (specifying what progress text is output during the ensemble development) and the location to save the ensemble. In this example we use the previously specified ensemble settings, we create a log setting named ‘ensemble’ and we save the ensemble to a directory named ‘testingEnsemble’ within the current working directory.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ensemble</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/runEnsemble.html">runEnsemble</a></span><span class="op">(</span>
  ensembleSettings <span class="op">=</span> <span class="va">ensembleSettings</span>,
  logSettings <span class="op">=</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createLogSettings.html">createLogSettings</a></span><span class="op">(</span>logName <span class="op">=</span> <span class="st">'ensemble'</span><span class="op">)</span>,
  saveDirectory <span class="op">=</span> <span class="st">'./testingEnsemble2'</span>
<span class="op">)</span></code></pre></div>
<p>If all the settings are specified correctly, you will see progress text reporting the evaluation performance of the base models and the ensemble.</p>
<p>When creating an ensemble using a list of <code>runPlp</code> objects the output <code>ensemble</code> can be an object of class <code>plpEnsemble</code> or an object of class <code>ensembleModel</code>. If the runPlp objects have all been developed using the same target population, with the same test/train split, then the test set can be used to evaluate the ensemble, so you will get an object of class <code>plpEnsemble</code>. However, if the runPlp objects were trained using different target populations (such as using different databases), then it is not possible to evaluate the ensemble using the resultList, so only the ensemble model, an object of class <code>ensembleModel</code>, will be returned.</p>
<p>An object of class <code>plpEnsemble</code> contains:</p>
<ol style="list-style-type: decimal">
<li>model - the ensemble model</li>
<li>prediction - a data.frame with the predictions for the ensemble and base models</li>
<li>performanceEvaluation - a list of objects with the internal validation of the base models and ensemble</li>
<li>analysisSettings - the analysisId for the ensemble</li>
<li>executionSettings - information about the execution of the ensemble development</li>
</ol>
<p>An object of class <code>ensembleModel</code> contains:</p>
<ol style="list-style-type: decimal">
<li>model - a list with the ensemble and baseModels</li>
<li>trainDetails - a list with training details</li>
<li>settings - the combination settings</li>
<li>covariateImportance - an empty data.frame</li>
</ol>
</div>
</div>
<div id="saving-and-loading-the-ensemble-model" class="section level2">
<h2 class="hasAnchor">
<a href="#saving-and-loading-the-ensemble-model" class="anchor"></a>Saving and loading the ensemble model</h2>
<p>You can save and load the ensemble result using:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/saveEnsemble.html">saveEnsemble</a></span><span class="op">(</span><span class="va">ensembleResults</span>, dirPath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"ensemble"</span><span class="op">)</span><span class="op">)</span>

<span class="va">ensembleResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadEnsemble.html">loadEnsemble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"ensemble"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>You can save and load the ensemble model result using:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/saveEnsembleModel.html">saveEnsembleModel</a></span><span class="op">(</span><span class="va">ensembleResults</span><span class="op">$</span><span class="va">model</span>, dirPath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"ensembleModel"</span><span class="op">)</span><span class="op">)</span>

<span class="va">ensembleModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadEnsembleModel.html">loadEnsembleModel</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"ensembleModel"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="apply-ensemble-model" class="section level1">
<h1 class="hasAnchor">
<a href="#apply-ensemble-model" class="anchor"></a>Apply Ensemble model</h1>
<p>To apply the ensemble to new data:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">newDatabaseDetails</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createDatabaseDetails.html">createDatabaseDetails</a></span><span class="op">(</span>
  connectionDetails <span class="op">=</span> <span class="st">'add new connection details'</span>,
<span class="op">)</span>

<span class="va">ensembleModel</span> <span class="op">&lt;-</span> <span class="fu">EnsemblePatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/loadEnsembleModel.html">loadEnsembleModel</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">'ensembleModel'</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">ensemblePrediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/applyEnsemble.html">applyEnsemble</a></span><span class="op">(</span>
  ensembleModel <span class="op">=</span> <span class="va">ensembleModel</span>,
  newDatabaseDetails <span class="op">=</span> <span class="va">newDatabaseDetails</span>,
  logSettings <span class="op">=</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createLogSettings.html">createLogSettings</a></span><span class="op">(</span><span class="op">)</span>,
  outputFolder <span class="op">=</span> <span class="st">'C:/locationToSaveBaseModelResults'</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="demo" class="section level1">
<h1 class="hasAnchor">
<a href="#demo" class="anchor"></a>Demo</h1>
<p>We have added a demo of the ensemble training:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Run the Ensemble demo</span>
<span class="fu"><a href="https://rdrr.io/r/utils/demo.html">demo</a></span><span class="op">(</span><span class="st">"EnsembleModelDemo"</span>, package <span class="op">=</span> <span class="st">"EnsemblePatientLevelPrediction"</span><span class="op">)</span></code></pre></div>
</div>
<div id="acknowledgments" class="section level1">
<h1 class="hasAnchor">
<a href="#acknowledgments" class="anchor"></a>Acknowledgments</h1>
<p>Considerable work has been dedicated to provide the <code>EnsemblePatientLevelPrediction</code> package.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/citation.html">citation</a></span><span class="op">(</span><span class="st">"PatientLevelPrediction"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## To cite PatientLevelPrediction in publications use:
## 
## Reps JM, Schuemie MJ, Suchard MA, Ryan PB, Rijnbeek P (2018). "Design
## and implementation of a standardized framework to generate and evaluate
## patient-level prediction models using observational healthcare data."
## _Journal of the American Medical Informatics Association_, *25*(8),
## 969-975. &lt;URL: https://doi.org/10.1093/jamia/ocy032&gt;.
## 
## A BibTeX entry for LaTeX users is
## 
##   @Article{,
##     author = {J. M. Reps and M. J. Schuemie and M. A. Suchard and P. B. Ryan and P. Rijnbeek},
##     title = {Design and implementation of a standardized framework to generate and evaluate patient-level prediction models using observational healthcare data},
##     journal = {Journal of the American Medical Informatics Association},
##     volume = {25},
##     number = {8},
##     pages = {969-975},
##     year = {2018},
##     url = {https://doi.org/10.1093/jamia/ocy032},
##   }</code></pre>
<p><strong>Please reference this paper if you use the PLP Package in your work:</strong></p>
<p><a href="http://dx.doi.org/10.1093/jamia/ocy032">Reps JM, Schuemie MJ, Suchard MA, Ryan PB, Rijnbeek PR. Design and implementation of a standardized framework to generate and evaluate patient-level prediction models using observational healthcare data. J Am Med Inform Assoc. 2018;25(8):969-975.</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jenna M Reps.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
